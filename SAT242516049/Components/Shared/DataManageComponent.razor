@using System.Reflection
@using Microsoft.AspNetCore.Components.Forms
@using SAT242516049.Data  @* <-- BU SATIRI MUTLAKA EKLE *@

@typeparam TItem where TItem : class, new()
@* ... kodlar devam ediyor ... *@

@inject IMyDbModel_Provider _provider
@inject IJSRuntime JSRuntime
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4>@Title</h4>
        <button class="btn btn-primary" @onclick="OpenCreateModal">
            <i class="bi bi-plus-lg"></i> Yeni Ekle
        </button>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text">Arama</span>
                    <input type="text" class="form-control" @bind="FilterText" @bind:event="oninput" @onkeyup="OnSearch" placeholder="Veri ara..." />
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        @foreach (var prop in GetVisibleProperties())
                        {
                            <th style="cursor:pointer" @onclick="() => Sort(prop.Name)">
                                @GetPropertyTitle(prop)
                                @if (CurrentMyDbModel.Parameters.OrderBy.Contains(prop.Name))
                                {
                                    <span>@(CurrentMyDbModel.Parameters.OrderBy.EndsWith("DESC") ? " ▼" : " ▲")</span>
                                }
                            </th>
                        }
                        <th style="width: 150px;">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @if (CurrentMyDbModel.Items != null && CurrentMyDbModel.Items.Any())
                    {
                        @foreach (var item in CurrentMyDbModel.Items)
                        {
                            <tr>
                                @foreach (var prop in GetVisibleProperties())
                                {
                                    <td>@prop.GetValue(item)</td>
                                }
                                <td>
                                    <button class="btn btn-sm btn-warning me-1" @onclick="() => OpenEditModal(item)">
                                        Güncelle
                                    </button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => Delete(item)">
                                        Sil
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="@(GetVisibleProperties().Count + 1)" class="text-center">Kayıt bulunamadı.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <span>Toplam Kayıt: @CurrentMyDbModel.Parameters.TotalRecordCount | Sayfa: @CurrentMyDbModel.Parameters.PageNumber / @CurrentMyDbModel.Parameters.TotalPageCount</span>
            <nav>
                <ul class="pagination">
                    <li class="page-item @(CurrentMyDbModel.Parameters.PageNumber <= 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PrevPage">Önceki</button>
                    </li>
                    <li class="page-item @(CurrentMyDbModel.Parameters.PageNumber >= CurrentMyDbModel.Parameters.TotalPageCount ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage">Sonraki</button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

@if (IsModalOpen)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(IsEditMode ? "Kayıt Güncelle" : "Yeni Kayıt Ekle")</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">
                            <strong>Hata:</strong> @ErrorMessage
                        </div>
                    }

                    <EditForm Model="CurrentItem" OnSubmit="Save">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        @foreach (var prop in GetEditableProperties())
                        {
                            <div class="mb-3">
                                <label class="form-label">@GetPropertyTitle(prop)</label>

                                @* --- DROPDOWN KONTROLÜ --- *@
                                @if (DropdownData != null && DropdownData.ContainsKey(prop.Name))
                                {
                                    <select class="form-select" @onchange="@(e => SetValue(prop, e.Value))">
                                        <option value="">Seçiniz...</option>
                                        @foreach (var item in DropdownData[prop.Name])
                                        {
                                            // Seçili olanı işaretle
                                            var currentVal = prop.GetValue(CurrentItem)?.ToString();
                                            <option value="@item.Id" selected="@(currentVal == item.Id)">@item.Text</option>
                                        }
                                    </select>
                                }
                                @* --- NORMAL INPUT KONTROLLERİ --- *@
                                else if (prop.PropertyType == typeof(bool))
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" checked="@((bool)prop.GetValue(CurrentItem)!)"
                                               @onchange="@(e => prop.SetValue(CurrentItem, e.Value))" />
                                        <label class="form-check-label">Aktif mi?</label>
                                    </div>
                                }
                                else if (prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?))
                                {
                                    <input type="date" class="form-control"
                                           value="@(prop.GetValue(CurrentItem) is DateTime dt ? dt.ToString("yyyy-MM-dd") : "")"
                                           @onchange="@(e => { if(DateTime.TryParse(e.Value?.ToString(), out DateTime d)) prop.SetValue(CurrentItem, d); })" />
                                }
                                else if (prop.PropertyType == typeof(int) || prop.PropertyType == typeof(decimal))
                                {
                                    <input type="number" class="form-control"
                                           value="@prop.GetValue(CurrentItem)"
                                           @onchange="@(e => SetValue(prop, e.Value))" />
                                }
                                else
                                {
                                    <input type="text" class="form-control"
                                           value="@prop.GetValue(CurrentItem)"
                                           @onchange="@(e => prop.SetValue(CurrentItem, e.Value?.ToString()))" />
                                }
                            </div>
                        }
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseModal">İptal</button>
                            <button type="submit" class="btn btn-success">Kaydet</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string Title { get; set; } = "Yönetim Paneli";
    [Parameter] public string SpList { get; set; } = "";
    [Parameter] public string SpAdd { get; set; } = "";
    [Parameter] public string SpUpdate { get; set; } = "";
    [Parameter] public string SpDelete { get; set; } = "";
    [Parameter] public string FilterColumnName { get; set; } = "Name";

    // YENİ PARAMETRE: Hangi kolonda hangi liste açılacak?
    [Parameter] public Dictionary<string, List<DropdownItem>> DropdownData { get; set; } = new();

    private IMyDbModel<TItem> CurrentMyDbModel { get; set; } = new MyDbModel<TItem>();
    private TItem CurrentItem { get; set; } = new TItem();
    private bool IsModalOpen = false;
    private bool IsEditMode = false;
    private string FilterText = "";
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
    }

    private async Task RefreshData()
    {
        if (!string.IsNullOrEmpty(FilterText))
        {
            if (CurrentMyDbModel.Parameters.Where.ContainsKey(FilterColumnName))
                CurrentMyDbModel.Parameters.Where[FilterColumnName] = FilterText;
            else
                CurrentMyDbModel.Parameters.Where.Add(FilterColumnName, FilterText);
        }
        else
        {
            if (CurrentMyDbModel.Parameters.Where.ContainsKey(FilterColumnName))
                CurrentMyDbModel.Parameters.Where.Remove(FilterColumnName);
        }
        CurrentMyDbModel = await _provider.Execute(CurrentMyDbModel, SpList, isPagination: true);
    }

    private async Task Save()
    {
        ErrorMessage = "";
        var spName = IsEditMode ? SpUpdate : SpAdd;
        var parameters = new List<(string Key, object Value)>();

        try
        {
            foreach (var prop in typeof(TItem).GetProperties())
            {
                string name = prop.Name;
                var val = prop.GetValue(CurrentItem);

                if (name.EndsWith("Name") && name != "Name" && name != "Surname") continue;
                if (name == "CreatedDate") continue;

                // IdentityNo veritabanına kaydedilmez, sadece gösterim içindir
// Sadece Fatura (Bill) tablosunda IdentityNo veritabanına gitmemeli.
// Müşteri tablosunda ise gitmek ZORUNDA.
if (typeof(TItem).Name == "Bill" && name == "IdentityNo") continue;

                if (!IsEditMode)
                {
                    if (name == "ID") continue;
                    if (name == "IsActive") continue;
                }

                if (prop.PropertyType == typeof(string))
                {
                    if (val == null) val = "";
                }
                else
                {
                    if (val == null) val = DBNull.Value;
                }
                parameters.Add((name, val));
            }

            var result = await _provider.Execute<TItem>(spName, parameters.ToArray());

            if (!string.IsNullOrEmpty(result.Message))
            {
                ErrorMessage = result.Message;
                StateHasChanged();
            }
            else
            {
                CloseModal();
                await RefreshData();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Sistem Hatası: {ex.Message}";
            Console.WriteLine(ex.Message);
        }
    }

    private async Task Delete(TItem item)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Bu kaydı silmek istediğinize emin misiniz?");
        if (confirmed)
        {
            var idProp = typeof(TItem).GetProperty("ID");
            if (idProp != null)
            {
                var id = idProp.GetValue(item);
                await _provider.Execute<TItem>(SpDelete, ("ID", id!));
                await RefreshData();
            }
        }
    }

    private async Task PrevPage()
    {
        if (CurrentMyDbModel.Parameters.PageNumber > 1)
        {
            CurrentMyDbModel.Parameters.PageNumber--;
            await RefreshData();
        }
    }

    private async Task NextPage()
    {
        if (CurrentMyDbModel.Parameters.PageNumber < CurrentMyDbModel.Parameters.TotalPageCount)
        {
            CurrentMyDbModel.Parameters.PageNumber++;
            await RefreshData();
        }
    }

    private async Task OnSearch()
    {
        CurrentMyDbModel.Parameters.PageNumber = 1;
        await RefreshData();
    }

    private async Task Sort(string columnName)
    {
        if (CurrentMyDbModel.Parameters.OrderBy == columnName)
            CurrentMyDbModel.Parameters.OrderBy = columnName + " DESC";
        else
            CurrentMyDbModel.Parameters.OrderBy = columnName;
        await RefreshData();
    }

    private void OpenCreateModal()
    {
        CurrentItem = new TItem();
        IsEditMode = false;
        IsModalOpen = true;
        ErrorMessage = "";
    }

    private void OpenEditModal(TItem item)
    {
        CurrentItem = new TItem();
        foreach (var prop in typeof(TItem).GetProperties())
        {
            if (prop.CanWrite)
                prop.SetValue(CurrentItem, prop.GetValue(item));
        }
        IsEditMode = true;
        IsModalOpen = true;
        ErrorMessage = "";
    }

    private void CloseModal() => IsModalOpen = false;

    private List<PropertyInfo> GetVisibleProperties()
    {
        return typeof(TItem).GetProperties()
            .Where(p => Attribute.IsDefined(p, typeof(TitleAttribute)))
            .ToList();
    }

    private List<PropertyInfo> GetEditableProperties()
    {
        return typeof(TItem).GetProperties()
            .Where(p => Attribute.IsDefined(p, typeof(TitleAttribute))
                        && p.Name != "ID"
                        && !p.Name.EndsWith("Name") // CustomerName, BillTypeName gizlensin
                                                    // --- EKLEMEN GEREKEN KISIM BAŞLANGIÇ ---
                        && !(typeof(TItem).Name == "Bill" && p.Name == "IdentityNo") // Faturada TC'yi gizle
                                                                                     // --- EKLEMEN GEREKEN KISIM BİTİŞ ---
                        || (p.Name == "Name" || p.Name == "Surname"))
            .ToList();
    }

    private string GetPropertyTitle(PropertyInfo prop)
    {
        var attr = prop.GetCustomAttribute<TitleAttribute>();
        return attr?.Title ?? prop.Name;
    }

    private void SetValue(PropertyInfo prop, object value)
    {
        try
        {
            if (value == null || value.ToString() == "") return;
            var type = Nullable.GetUnderlyingType(prop.PropertyType) ?? prop.PropertyType;
            var converted = Convert.ChangeType(value, type);
            prop.SetValue(CurrentItem, converted);
        }
        catch { }
    }
}